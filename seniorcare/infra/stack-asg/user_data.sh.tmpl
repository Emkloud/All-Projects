#!/bin/bash
set -eux
# Install Nginx and AWS CLI
(dnf install -y nginx awscli amazon-cloudwatch-agent) || (yum install -y nginx awscli amazon-cloudwatch-agent)
systemctl enable nginx

# Create web root
WEB_ROOT=/usr/share/nginx/html
mkdir -p $${WEB_ROOT}

# Sync static site from S3 bucket variable
AWS_REGION="${region}"
SITE_BUCKET="${bucket}"

aws s3 sync s3://$${SITE_BUCKET}/ $${WEB_ROOT}/ --region $${AWS_REGION} --delete || true

# Basic Nginx hardening: add default index if missing
if [ ! -f $${WEB_ROOT}/index.html ]; then
  cat > $${WEB_ROOT}/index.html <<'HTML'
  <!DOCTYPE html>
  <html lang="en"><head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SeniorCare</title>
  </head><body>
    <h1>SeniorCare</h1>
    <p>Site is provisioning... please refresh shortly.</p>
  </body></html>
HTML
fi

# Open SELinux httpd read (if applicable) â€“ AL2023 permissive by default; ignore failures
(setsebool -P httpd_read_user_content 1) || true

# Start Nginx
systemctl restart nginx

# Configure CloudWatch Agent for log shipping
cat >/opt/aws/amazon-cloudwatch-agent/bin/config.json <<'JSON'
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {"file_path": "/var/log/nginx/access.log", "log_group_name": "/seniorcare/nginx/access", "log_stream_name": "{instance_id}", "timestamp_format": "%d/%b/%Y:%H:%M:%S %z"},
          {"file_path": "/var/log/nginx/error.log",  "log_group_name": "/seniorcare/nginx/error",  "log_stream_name": "{instance_id}"},
          {"file_path": "/var/log/cloud-init-output.log", "log_group_name": "/seniorcare/cloud-init", "log_stream_name": "{instance_id}"}
        ]
      }
    },
    "force_flush_interval": 5
  }
}
JSON

systemctl enable amazon-cloudwatch-agent
/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s || true
